#!/bin/bash

# Script to finish a hotfix branch
# Usage: ./scripts/finish-hotfix.sh

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored messages
print_error() {
    echo -e "${RED}ERROR: $1${NC}"
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_info() {
    echo -e "${YELLOW}➜ $1${NC}"
}

# Function to check if there are uncommitted changes
check_uncommitted_changes() {
    if [[ -n $(git status -s) ]]; then
        print_error "You have uncommitted changes. Please commit or stash them first."
        git status -s
        exit 1
    fi
}

# Function to check if branch exists
branch_exists() {
    git show-ref --verify --quiet refs/heads/$1
}

# Get current branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
print_info "Current branch: $CURRENT_BRANCH"

# Verify it's a hotfix branch
if [[ ! "$CURRENT_BRANCH" =~ ^hotfix/ ]]; then
    print_error "Current branch is not a hotfix branch (must start with 'hotfix/')"
    exit 1
fi

# Check for uncommitted changes
check_uncommitted_changes

# Show what will be done
echo ""
print_info "This will:"
echo "  1. Fetch latest changes from remote"
echo "  2. Merge '$CURRENT_BRANCH' into 'master'"
echo "  3. Merge 'master' into 'develop'"
echo "  4. Push 'master' and 'develop' to remote"
echo ""

# Step 1: Fetch from remote
print_info "Fetching from remote..."
git fetch origin

# Step 2: Checkout and update master
print_info "Checking out master..."
git checkout master

print_info "Pulling latest master..."
git pull origin master

# Step 3: Merge hotfix into master
print_info "Merging $CURRENT_BRANCH into master..."
if git merge --no-ff "$CURRENT_BRANCH" -m "Merge $CURRENT_BRANCH into master"; then
    print_success "Successfully merged $CURRENT_BRANCH into master"
else
    print_error "Failed to merge $CURRENT_BRANCH into master"
    print_error "Please resolve conflicts manually"
    exit 1
fi

# Step 4: Checkout and update develop
print_info "Checking out develop..."
if branch_exists develop; then
    git checkout develop
else
    print_error "Branch 'develop' does not exist locally. Creating from remote..."
    git checkout -b develop origin/develop
fi

print_info "Pulling latest develop..."
git pull origin develop

# Step 5: Merge master into develop
print_info "Merging master into develop..."
if git merge --no-ff master -m "Merge master into develop (from $CURRENT_BRANCH)"; then
    print_success "Successfully merged master into develop"
else
    print_error "Failed to merge master into develop"
    print_error "Please resolve conflicts manually"
    exit 1
fi

# Step 6: Push master and develop
print_info "Pushing master to remote..."
git push origin master
print_success "Pushed master"

# Step 6.5: Trigger production deployment workflow
print_info "Looking for production deployment workflow..."
WORKFLOW=$(gh workflow list | grep -i "prod" | grep -i "deployment" | head -n 1 | awk '{sub(/[[:space:]]+(active|disabled|state).*/, ""); print}')

if [ -n "$WORKFLOW" ]; then
    print_info "Found workflow: $WORKFLOW"
    print_info "Triggering production deployment workflow on master..."
    if gh workflow run "$WORKFLOW" --ref master; then
        print_success "Production deployment workflow triggered"
    else
        print_error "Failed to trigger workflow, but continuing..."
    fi
else
    print_info "No production deployment workflow found (looking for 'Prod' + 'Deployment' keywords)"
    print_info "Skipping workflow trigger"
fi

print_info "Pushing develop to remote..."
git push origin develop
print_success "Pushed develop"

# Delete hotfix branch
echo ""
print_info "Cleaning up hotfix branch..."
git checkout master  # Ensure we're not on the branch we're deleting
git branch -d "$CURRENT_BRANCH"
print_success "Deleted local branch $CURRENT_BRANCH"

git push origin --delete "$CURRENT_BRANCH"
print_success "Deleted remote branch $CURRENT_BRANCH"

echo ""
print_success "Hotfix workflow completed successfully!"
print_info "Current branch: $(git rev-parse --abbrev-ref HEAD)"
